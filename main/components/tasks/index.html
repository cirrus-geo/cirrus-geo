

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasks &mdash; Cirrus  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/js/versions-loader.js?v=38b9fbf7"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="post-batch" href="post-batch.html" />
    <link rel="prev" title="pre-batch" href="../functions/pre_batch.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Cirrus
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Cirrus documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/10_intro.html">Getting started with Cirrus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/20_arch.html">Cirrus architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/30_payload.html">Cirrus Payload</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/40_config-deploy.html">Configuration and Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/50_operation.html">Basic Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/60_components.html">Cirrus Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/65_cloudformation.html">Cloudformation Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/70_statedb.html">State Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/80_monitoring.html">Pipeline Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/90_examples.html">Cirrus Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/95_tips_and_tricks.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cirrus/96_deploying.html">Deploying</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Component READMEs</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../functions/index.html">Functions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tasks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="post-batch.html">post-batch</a></li>
<li class="toctree-l2"><a class="reference internal" href="pre-batch.html">pre-batch</a></li>
<li class="toctree-l2"><a class="reference internal" href="publish.html">publish</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/index.html">Workflows</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Cirrus CLI READMEs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli/00_intro.html">CLIrrus Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli/01_install.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli/02_auth.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli/03_deployments.html">CLIrrus and Cirrus Deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli/04_commands.html">Command Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cirrus</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tasks</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/components/tasks/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tasks">
<h1>Tasks<a class="headerlink" href="#tasks" title="Link to this heading"></a></h1>
<p>Tasks in Cirrus implement a unit of processing, to be composed together into a
<a class="reference internal" href="../workflows/index.html"><span class="doc">Workflow</span></a>. Tasks are expected to support both input and
output formatted as a <span class="xref std std-doc">Cirrus Payload</span>. As part of its
processing, a task can make any requisite modifications to its input payload
and/or derive any output assets, pushing them to the canonical storage location
in S3.</p>
<p>In other other words, to implement custom processing routines for a pipeline,
use a task. The best tasks are modular, simple, focused, and composable. Most
projects end up with more custom tasks than other component types, so it pays
to be familiar with the tasks ins and outs.</p>
<p>Tasks can make use of AWS Lambda and/or AWS Batch for execution. Lambda tasks
are simpler to manage and quicker to start up, but the Lambda runtime
constraints can be prohibitive or untenable for some task workloads. In those
cases, Batch allows for extended runtimes, greater resource limits, and
specialized instance types.</p>
<section id="anatomy-of-a-task">
<h2>Anatomy of a task<a class="headerlink" href="#anatomy-of-a-task" title="Link to this heading"></a></h2>
<p>Generally speaking, every task should do a few key things:</p>
<ul class="simple">
<li><p>Take an input Cirrus Payload</p>
<ul>
<li><p>In the case of Batch tasks and/or large payloads, tasks should support
receiving a <code class="docutils literal notranslate"><span class="pre">url</span></code> input parameter pointing to a payload object in S3</p></li>
</ul>
</li>
<li><p>Download any/all required assets from the items in the input payload</p></li>
<li><p>Perform any asset metadata manipulation and/or derived product processing</p></li>
<li><p>Update/replace payload items based on task outputs</p></li>
<li><p>Upload any output assets/items to S3 for persistence</p></li>
<li><p>Return the output Cirrus Payload</p>
<ul>
<li><p>In the case of Batch tasks and/or large payloads, tasks should support
uploading the output payload to S3 and returning an output <code class="docutils literal notranslate"><span class="pre">url</span></code> parameter
pointing to that payload object in S3</p></li>
</ul>
</li>
</ul>
<p>Certain tasks may deviate from this pattern, but the vast majority of tasks will
follow this flow, either in part or in full. The python <code class="docutils literal notranslate"><span class="pre">stac-task</span></code> library provides convenience classes/methods to help build tasks and easily facilitate these common actions.</p>
<section id="lambda-tasks">
<h3>Lambda tasks<a class="headerlink" href="#lambda-tasks" title="Link to this heading"></a></h3>
<p>Lambda tasks use the <a class="reference external" href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html">AWS Lambda</a> runtime to power executions. Lambda has the
advantage of quick startup and easy management, but has many restrictions like
short timeouts and significant resource limits.</p>
<p>Lambda-only tasks follow the specifications outlined in the <span class="xref std std-doc">Lambda-based
components</span> documentation. Refer there for specifics on what files
are requried for Lambda tasks and how to structure the <code class="docutils literal notranslate"><span class="pre">definition.yml</span></code> file.</p>
</section>
<section id="batch-tasks">
<h3>Batch tasks<a class="headerlink" href="#batch-tasks" title="Link to this heading"></a></h3>
<p>Batch tasks use <a class="reference external" href="https://docs.aws.amazon.com/batch/latest/userguide/what-is-batch.html">AWS Batch</a> semantics to define <a class="reference external" href="https://docs.aws.amazon.com/batch/latest/userguide/jobs.html">jobs</a> that execute within a
<a class="reference external" href="https://docs.aws.amazon.com/batch/latest/userguide/compute_environments.html">compute environment</a> as determined by the <a class="reference external" href="https://docs.aws.amazon.com/batch/latest/userguide/job_queues.html">job queue</a> to which the job is
submitted.  Batch compute environments can make use of <a class="reference external" href="https://docs.aws.amazon.com/eks/latest/userguide/fargate.html">Fargate</a> or <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html">EC2</a> to
run jobs, allowing significantly more control over the execution environment
than Lambda allows, as well as much greater limits on resources.</p>
<p>Batch tasks are inherently just an abstraction around a set of CloudFormation
resources, minimally just a Batch <a class="reference external" href="https://docs.aws.amazon.com/batch/latest/userguide/job_definitions.html">job definition</a>, but commonly also the job
queue, compute environment, and any other requried resources.</p>
<p>For more infomation see the <span class="xref std std-doc">Batch tasks</span> documentation.</p>
</section>
</section>
<section id="lambda-vs-batch">
<h2>Lambda vs Batch<a class="headerlink" href="#lambda-vs-batch" title="Link to this heading"></a></h2>
<section id="when-to-chose-either">
<h3>When to chose either<a class="headerlink" href="#when-to-chose-either" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>can be run as a Docker image</p></li>
</ul>
</section>
<section id="when-to-chose-lambda">
<h3>When to chose Lambda<a class="headerlink" href="#when-to-chose-lambda" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>short runtime, with a maximum of 15 minutes</p></li>
<li><p>single vCPU is acceptable</p></li>
<li><p>under 10GB of memory</p></li>
<li><p>small code size / few dependencies</p></li>
<li><p>need code to live in the cirrus project repository</p></li>
</ul>
</section>
<section id="when-to-chose-batch">
<h3>When to chose Batch<a class="headerlink" href="#when-to-chose-batch" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>runtime always longer than 5 minutes</p></li>
<li><p>larger package size / many dependencies</p></li>
<li><p>need multiple vCPUs, more than 10GB memory, or the ability to more precisely specify a vCPU-to-memory ratio</p></li>
<li><p>easier to manage code as separate container images</p></li>
<li><p>need more than 10GB storage</p></li>
<li><p>need special hardware resources (e.g., GPU)</p></li>
</ul>
</section>
</section>
<section id="docker-image">
<h2>Docker Image<a class="headerlink" href="#docker-image" title="Link to this heading"></a></h2>
<p>It is generally recommended to use a Docker image for tasks unless the task is only
intended to run in Lambda and has few dependencies, which is rarely the case with
geospatial processing.</p>
<p>The easiest way to do this is to create a Python class that extends stactask.task.Task
and implements the abstract method <cite>def process(self, **kwargs: Any) -&gt; List[Dict[str, Any]]</cite>.
This class should be put in the file <cite>src/task/task.py</cite>, and can then be invoked by
Docker with directives:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FROM public.ecr.aws/lambda/python:3.11

# ENTRYPOINT [&quot;/lambda-entrypoint.sh&quot;] # set by base lambda image
COPY src/task/task.py ${LAMBDA_TASK_ROOT}/task.py
CMD [ &quot;task.handler&quot; ]
</pre></div>
</div>
<p>If you choose to use your own container that is not based on a standard Lambda image,
you must add the <cite>lambda-entrypoint.sh</cite> file to your image and set <cite>ENTRYPOINT</cite> explicitly.</p>
<p>Unfortuantely, the same Docker image cannot be used by both Batch and Lambda, as they
have slightly different requirements for the <cite>CMD</cite> and <cite>ENTRYPOINT</cite> parameters. The
solution to this is to have one base image definition that has all directives exception
<cite>CMD</cite> and <cite>ENTRYPOINT</cite>, and then create two image definitions that use the base image
but set <cite>CMD</cite> and <cite>ENTRYPOINT</cite>. For example, if we had a image that used a standard
AWS lambda image (public.ecr.aws/lambda/python:3.11), we would use these directives for
Batch and Lambda.</p>
<p>Batch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>COPY src/task/task.py ${LAMBDA_TASK_ROOT}/task.py
ENTRYPOINT []
</pre></div>
</div>
<p>(any prior <cite>CMD</cite> will be reset by the ENTRYPOINT change, and the command is set by the Batch Job Definition)</p>
<p>Lambda:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>COPY src/task/task.py ${LAMBDA_TASK_ROOT}/task.py
CMD [ &quot;task.handler&quot; ]
</pre></div>
</div>
<p>(base image sets <cite>ENTRYPOINT [“/lambda-entrypoint.sh”]</cite>)</p>
<p>Thereby, an example base image that needed geospatial tools could look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FROM ghcr.io/lambgeo/lambda-gdal:3.8-python3.11 as gdal

FROM public.ecr.aws/lambda/python:3.11

# Bring C libs from lambgeo/lambda-gdal image
COPY --from=gdal /opt/lib/ ${LAMBDA_TASK_ROOT}/lib/
COPY --from=gdal /opt/include/ ${LAMBDA_TASK_ROOT}/include/
COPY --from=gdal /opt/share/ ${LAMBDA_TASK_ROOT}/share/
COPY --from=gdal /opt/bin/ ${LAMBDA_TASK_ROOT}/bin/

ENV \
  GDAL_DATA=${LAMBDA_TASK_ROOT}/share/gdal \
  PROJ_LIB=${LAMBDA_TASK_ROOT}/share/proj \
  GDAL_CONFIG=${LAMBDA_TASK_ROOT}/bin/gdal-config \
  GEOS_CONFIG=${LAMBDA_TASK_ROOT}/bin/geos-config \
  PATH=${LAMBDA_TASK_ROOT}/bin:$PATH

RUN yum update -y &amp;&amp; \
    yum install -y libxml2-devel libxslt-devel python-devel gcc &amp;&amp; \
    yum clean all &amp;&amp; \
    rm -rf /var/cache/yum /var/lib/yum/history

COPY requirements.txt ${LAMBDA_TASK_ROOT}

RUN pip3 install --no-cache-dir -r requirements.txt

COPY src/task/task.py ${LAMBDA_TASK_ROOT}/task.py
</pre></div>
</div>
<p>That could be built and tagged as the base image, and then the Lambda and/or Batch images
based on it.</p>
<p>Batch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">my_base_task</span>

<span class="n">ENTRYPOINT</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Lambda:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">my_base_task</span>

<span class="n">CMD</span> <span class="p">[</span> <span class="s2">&quot;task.handler&quot;</span> <span class="p">]</span>
</pre></div>
</div>
<p>Of course, if only one of the Batch or Lambda is needed, these commands can be combined into
a single definition.</p>
</section>
<section id="task-parameters">
<h2>Task parameters<a class="headerlink" href="#task-parameters" title="Link to this heading"></a></h2>
<p>Tasks can take arguments at runtime via process definition parameters. See the
<span class="xref std std-doc">Cirrus Payload</span> docs for more information.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="post-batch.html">post-batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="pre-batch.html">pre-batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="publish.html">publish</a></li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../functions/pre_batch.html" class="btn btn-neutral float-left" title="pre-batch" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="post-batch.html" class="btn btn-neutral float-right" title="post-batch" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 - 2024, Element 84.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div
  class="rst-versions"
  data-toggle="rst-versions"
  role="note"
  aria-label="Versions"
>
  <span class="rst-current-version" data-toggle="rst-current-version">
    v: main
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="versions-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>