# main application name
service: cirrus

# high level config
provider:
  name: aws
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-west-2'}
  runtime: python3.9
  environment:
    CIRRUS_STAC_DESCRIPTION: ${self:service}-${self:provider.stage} STAC
    CIRRUS_PUBLIC_CATALOG: False
    #CIRRUS_API_URL: <url>
    CIRRUS_STAC_VERSION: 1.0.0-beta.2
    CIRRUS_LOG_LEVEL: DEBUG
    CIRRUS_BUCKET: !Ref ServerlessDeploymentBucket
    CIRRUS_DATA_BUCKET: !Ref Data
    CIRRUS_PAYLOAD_BUCKET: !Ref Payloads
    CIRRUS_STATE_DB: !Ref StateTable
    CIRRUS_STACK: ${self:service}-${self:provider.stage}
    BASE_WORKFLOW_ARN: "arn:aws:states:#{AWS::Region}:#{AWS::AccountId}:stateMachine:${self:service}-${self:provider.stage}-"
    CIRRUS_PROCESS_QUEUE: ${self:service}-${self:provider.stage}-process
    CIRRUS_PROCESS_TOPIC_ARN: arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:service}-${self:provider.stage}-queue
    CIRRUS_PUBLISH_TOPIC_ARN: arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:service}-${self:provider.stage}-publish
    CIRRUS_FAILED_TOPIC_ARN: arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:service}-${self:provider.stage}-failed
    CIRRUS_INVALID_TOPIC_ARN: arn:aws:sns:#{AWS::Region}:#{AWS::AccountId}:${self:service}-${self:provider.stage}-failed
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - lambda:InvokeFunction
      Resource:
        - arn:aws:lambda:#{AWS::Region}:#{AWS::AccountId}:function:cirrus*
    - Effect: "Allow"
      Action: "s3:*"
      Resource: "*"
    - Effect: "Allow"
      Action: secretsmanager:GetSecretValue
      Resource:
        - arn:aws:secretsmanager:#{AWS::Region}:#{AWS::AccountId}:secret:cirrus*

custom:
  batch:
    SecurityGroupIds:
      - ${env:SECURITY_GROUP_1}
    Subnets:
      - ${env:SUBNET_1}
      - ${env:SUBNET_2}
      - ${env:SUBNET_3}
      - ${env:SUBNET_4}
    BasicComputeEnvironments:
      MaxvCpus: 128
    LambdaAsBatchJob:
      Memory: 2048
      Vcpus: 1
    GeoLambdaAsBatchJob:
      Memory: 2048
      Vcpus: 1
  pythonRequirements:
    slim: true
    slimPatternsAppendDefaults: false
    slimPatterns:
      - 'botocore/**'
      - 'botocore-*/**'
      - 'boto3/**'
      - 'boto3-*/**'
      - 'bin/**'
      - 'dateutils*'
      - 'docutils/**'
      - 'docutils-*/**'
      - 'numpy/**'
      - 'numpy-*/**'
      - 'rasterio/**'
      - 'rasterio-*/**'
      - 'six.py'
      - 'six-*/**'
      - 'urllib3/**'
      - 'urllib3-*/**'
      - 'jmespath/**'
      - 'jmespath-*/**'
