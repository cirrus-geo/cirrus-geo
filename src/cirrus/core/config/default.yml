# main application name
service: cirrus

# high level config
provider:
  name: aws
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-west-2'}
  runtime: python3.9
  environment:
    CIRRUS_LOG_LEVEL: DEBUG
    CIRRUS_BUCKET: !Ref ServerlessDeploymentBucket
    CIRRUS_DATA_BUCKET: !Ref Data
    CIRRUS_PAYLOAD_BUCKET: !Ref Payloads
    CIRRUS_STATE_DB: !Ref StateTable
    CIRRUS_STACK: "#{AWS::StackName}"
    CIRRUS_PROCESS_QUEUE: !Ref ProcessQueue
    CIRRUS_PROCESS_TOPIC_ARN: !Ref ProcessTopic
    CIRRUS_PUBLISH_TOPIC_ARN: !Ref PublishTopic
    CIRRUS_FAILED_TOPIC_ARN: !Ref FailedTopic
    CIRRUS_INVALID_TOPIC_ARN: !Ref FailedTopic
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - lambda:InvokeFunction
      Resource:
        - arn:aws:lambda:#{AWS::Region}:#{AWS::AccountId}:function:#{AWS::StackName}*
    - Effect: "Allow"
      Action: "s3:*"
      Resource: "*"
    - Effect: "Allow"
      Action: secretsmanager:GetSecretValue
      Resource:
        - arn:aws:secretsmanager:#{AWS::Region}:#{AWS::AccountId}:secret:cirrus*

custom:
  batch:
    SecurityGroupIds:
      - ${env:SECURITY_GROUP_1}
    Subnets:
      - ${env:SUBNET_1}
      - ${env:SUBNET_2}
      - ${env:SUBNET_3}
      - ${env:SUBNET_4}
    BasicComputeEnvironments:
      MaxvCpus: 128
    LambdaAsBatchJob:
      Memory: 2048
      Vcpus: 1
    GeoLambdaAsBatchJob:
      Memory: 2048
      Vcpus: 1
  pythonRequirements:
    slim: true
    slimPatternsAppendDefaults: false
    slimPatterns:
      - 'botocore/**'
      - 'botocore-*/**'
      - 'boto3/**'
      - 'boto3-*/**'
      - 'bin/**'
      - 'dateutils*'
      - 'docutils/**'
      - 'docutils-*/**'
      - 'numpy/**'
      - 'numpy-*/**'
      - 'rasterio/**'
      - 'rasterio-*/**'
      - 'six.py'
      - 'six-*/**'
      - 'urllib3/**'
      - 'urllib3-*/**'
      - 'jmespath/**'
      - 'jmespath-*/**'
